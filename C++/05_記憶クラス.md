05 記憶クラス
===========

## 1. 記憶域期間

* オブジェクトは、記憶期間を持つ

  * 記憶期間：確保された記憶域が有効である期間

* 記憶クラス指定子：記憶期間を指定可能

| 記憶域期間     | 説明                                                                                                                                                           |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 自動記憶域期間 | `auto`・`register`と明示してある局所オブジェクト、`static`・`extern`と明示して無い局所オブジェクトの持つ記憶域期間。それを生成したブロックを抜け出すまで有効。 |
| 静的記憶域期間 | `static`と明示してある局所オブジェクト、及び動的記憶域期間を持たないグローバルオブジェクトの持つ記憶域期間。プログラムの実行期間中ずっと有効。                 |
| 動的記憶域期間 | `new`式を使って動的に確保した記憶域期間。`delete`式で開放するか、プログラム終了まで有効。                                                                      |



## 2. 記憶クラス指定子

* `auto`

* `register`

* `static`

* `extern`

* `mutable`



### `auto`

* ブロック内及び関数仮引数内で適用可能

* 宣言が含まれるブロック内だけで有効になる

    > このような変数を、「自動変数」という

* `auto`は省略可能であり、通常は省略される



### `register`

* `auto`と同じ意味を持つ

* ただし、指定した変数の使用頻度が高いというヒントをコンパイラに与える

* 処理系はこの情報を無視しても良い



### `static`

* 変数名、関数名、無名の共用体に適用可能

* オブジェクトが静的記憶域期間を持つことを指定する

* 変数の場合：静的変数



### `extern`

* 変数名と関数名に適用できる

* その識別子が外部結合(外部リンケージ)可能であることを指定する



### `mutable`

* クラスのデータメンバに適用でき、`const`効果を取り消す

* `const`指定つき宣言のクラスオブジェクトであっても、`mutable`指定で宣言されているデータメンバは変更可能となる

```cpp
extern int ex;

void foo()
{
  auto int a;
  int b;
  register int c;
  static int d;
}
```



## 3. ローカル変数とグローバル変数

* ローカル変数(局所変数)：関数の内部で宣言した、その関数の中だけで有効な変数

* グローバル変数(広域変数)：関数の外側で宣言された、そのファイル内のどの関数からでも使用可能な変数

* 有効範囲(スコープ)：変数が利用可能な範囲



## 4. 自動変数と静的変数

* 自動変数：`auto`を付けるか、あるいは`auto`を省略した形式で宣言したローカル変数

  * その関数の中だけ使用できる

  * その関数が呼び出されたとき、メモリ上に記憶域が確保され、関数の実行が終了すると、開放される

* 静的変数：関数内のローカル変数に`static`修飾をつけた変数

  * 静的領域に確保され、関数の実行が終了しても値を維持する

```cpp
#include <iostream>
using namespace std;

// グローバル変数
int g = 0;

void func()
{
  // 自動変数
  int a = 0;

  // ローカルな静的変数
  static int s = 0;
  ++g; ++a; ++a;
  cout << "g=" << g << " a=" << a << " s=" << s << endl;
}

int main()
{
  func(); // g=1 a=1 s=1
  func(); // g=2 a=1 s=2
  func(); // g=3 a=1 s=3
  return 0;
}
```



## 5. 識別子の結合と翻訳単位

* 翻訳単位：１回ずつのコンパイル対象

  * 複数のソースファイルで構成されるファイルを個別にコンパイルしてから、一つの実行ファイルを作成

  * 前処理後のプログラムテキスト

* C++では、翻訳単位によって変数の適用範囲が変化する

  * 外部結合

  * 内部結合

  * 無結合



### 外部結合

* `a.cpp`の中で宣言された識別子を、`b.cpp`でも参照できる結合

* リンカに識別子情報を渡す。識別子の実体は全体でひとつしかない

    > 例)`extern`のついたグローバル変数は外部結合



### 内部結合

* `a.cpp`の中で宣言された識別子を`b.cpp`では参照できない結合

* 両方で同じ名前の識別子を衝突なしに使うことができる

    > 例)`static`のついたグローバル変数は内部結合である



### 無結合

* 複数ファイル間の結合とは無関係な状態をいう

    > 例)関数内で宣言されたローカル変数や仮引数は無結合である



## 6. 内部結合と外部結合の指定

* 関数名

  * デフォルト：外部結合

  * `static`：内部結合

* グローバルな変数名

  * `extern`：外部結合、その実体が別の翻訳単位にあることを知らせる

  * `static`：内部結合

**t1.cpp**

```cpp
#include <iostream>
using namespace std;
void sub();

int gg = 99;
static int st = 10;
extern int ex;

void funcA()
{
  cout << "t1:funcA\n";
}

static void funcB()
{
  cout << "t1:st=" << st << " ex=" << ex << " gg=" << gg << endl;
}

int main()
{
  funcA();
  funcB();
  sub();
  return 0;
}
```

**t2.cpp**

```cpp
#include <iostream>
using namespace std;

// int gg = 99;
int st = 20;
int ex = 50;

// void funcA()
// {
//   cout << "t2:funcA()\n"
// }

void funcB()
{
  cout << "t2:st=" << st << " ex=" << ex << endl;
}

void sub()
{
  funcB();
}
```



## 7. 宣言位置と有効範囲

### 宣言位置で有効

* 変数はその宣言位置以降で有効と成る

```cpp
int a;
a = 1;
int b;
b = a;
int c = 10, *p = &c;
```



### 宣言位置と有効範囲

1. ブロック`{}`内で宣言した名前は、その領域の終わりまで有効

2. 関数ブロック内で宣言した名前は、その関数領域の終わりまで有効

3. 関数仮引数はその関数内で有効

4. for初期化文の中及び、if、while、for、switch文の条件部分で宣言した名前は、その制御文の終わりまで有効

5. ラベルはそれが記述されている関数内で有効



### 名前の隠蔽

* 宣言されている名前の有効範囲の内側に、内包する形で宣言された名前は、優先参照され、外側領域の名前を隠す

```cpp
int a = 10;

void func()
{
  int a = 20;
  cout << a << endl;
  if (a > 0) {
    cout << a << endl;
  }
  cout << a << endl;
  {
    int a = 40;
    cout << a << endl;
  }
}
```



### スコープ解決演算子

* 同じ名前のグローバル変数とローカル変数が合った場合、関数内ではローカル変数が優先される

* スコープ解決演算子：裏に隠れたグローバル変数を参照する

```cpp
int d = 10;
void func()
{
  int d = 20;
  cout << ::d << " " << d << endl;
}
```



## 8. 言語結合

### 言語リンケージの機能

* 異なる言語で書かれたコードを利用可能にする

```cpp
// myfunc1関数はCリンケージを持つ
extern "C" int myunc1(int n);

// 次の２つの関数はCリンケージを持つ
extern "C"
{
  int myfunc2();
  int myfunc3(int n);
}
```



### 言語リンケージの指定

```c
int add (int a, int b)
{
  return a + b;
}
```

```cpp
#include <iostream>
using namespace std;

extern "C" int add(int a, int b);

int main()
{
  cout << add(100, 200) << endl;
  return 0;
}
```



| 版  | 年月日     |
| --- | ---------- |
| 1st | 2020/08/11 |
